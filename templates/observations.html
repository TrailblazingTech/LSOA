{% extends 'base/b4_base_with_nav.html' %}

{% load staticfiles %}
{% load observations %}

{% block extrastyles %}
  <link rel="stylesheet" href="{% static 'vendor/lightbox2/css/lightbox.min.css' %}">
  <style>
    [role="tooltip"] {
      z-index: 9999999;
    }

    table, .ios .page {
      background-color: #fff !important;
    }

    .modal.show {
      z-index: 5010;
    }

    [data-modal-launch-observations] {
      cursor: pointer;
    }

    [data-modal-launch-observations] i {
      color: goldenrod;
    }

    [data-modal-launch-observations]:hover i {
      color: darkgoldenrod;
    }

    .star-number {
      font-size: 12px;
    }

    .dot {
      height: 25px;
      width: 25px;
      background-color: #f2a287;
      border-radius: 50%;
      display: inline-block;
      margin: 3px auto;
    }

    .dot:hover {
      background-color: #cb6634;
    }

    /*
     * Height of date input is broken if there is no value. It have been
     * solved in higher version of bootstrap.
     */
    input[type="date"] {
	     height: 2.375rem;
    }
  </style>
{% endblock %}

{% block extrascripts %}
  <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/js/select2.min.js"></script>
  <script src="{% static 'vendor/fabricjs/fabricjs.min.js' %}"></script>
  <script>
    function initSelect2() {
      $("#id_constructs").select2({
        tokenSeparators: [',', '\n']
      });
      $("#id_tags").select2({
        tokenSeparators: [',', '\n']
      });
    }

    function loadAllowedConstructs() {
      if ($("#construct-row").hasClass('d-none')) {
        return
      }
      var date_from = $('#id_date_from').val();
      var date_to = $('#id_date_to').val();
      var course = $('#courseSelector').val();
      if (isNaN(course)) {
        course = undefined;
      }

      $.ajax({
        type: 'POST',
        url: '{% url "observations-ajax" %}',
        dataType: 'json',
        data: {
          'course': course,
          'date_to': date_to,
          'date_from': date_from,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function (response) {
          var data = response['data'];
          var selected = $('#id_constructs').val();
          $('#id_constructs').empty();

          $.each(data, function(index, option) {
            $('#id_constructs').append( new Option(option.value, option.id) );
          });
          $('#id_constructs').val(selected).trigger('change');
        },
        error: function (xhr, status, e) {

        }
      });
    }

    $( document ).ready(function() {
      initSelect2();
      loadAllowedConstructs();
      $('.datepicker').datepicker({
          uiLibrary: 'bootstrap4'
      });
    });

    function registerUpdateConstructsListener(id) {
      var listeners = ['change', 'unfocus'];
      listeners.forEach(function(listener) {
        $(id).on(listener, loadAllowedConstructs);
      });
    }

    registerUpdateConstructsListener('#id_date_from');
    registerUpdateConstructsListener('#id_date_to');


    function loadVideo(id, key) {
        var $video = $('#' + key + '-source-' + id)[0];
        if ($video) {
            var link = $video.value;
            var $videoContainer = $('#' + key + '-' + id)[0];
            var $videoElement = $('<video />', {
                style: 'width: 100%; height: 100%;',
                src: link,
                type: 'video/mp4',
                controls: true
            })[0];

            $videoContainer.append($videoElement);
            $video.remove();
        }
    }

    function loadPicture(id) {
        var $canvas = $('#the-modal .modal-body #' + id);
        $canvas.attr('id', 'canvas' + id);

        var annotation_data = $('#annotation_data_' + id).html();

        $('#the-modal').on('shown.bs.modal', function() {
            var url = $('#image-source-'+id).html();
            if (!url) {
              return;
            }

            var canvas = new fabric.Canvas('canvas' + id, {
                isDrawingMode: false,
                selection: false
            });

            var cHeight = 332;
            var cWidth = 530;
            var cWidthFull = 768;

            var bgImg = new fabric.Image();
            bgImg.setSrc(url.replace(/&amp;/g, '&'), function() {
                var height = Math.min(bgImg.height, cHeight);
                var width = Math.min(bgImg.width, cWidth);
                var naturalWidth = bgImg.getOriginalSize().width;
                var imgScale = width / naturalWidth;

                var ctx = {};
                if (annotation_data !== "") {
                    var ctx = JSON.parse(annotation_data.replace(/&quot;/g, '"'));
                }

                var originalHeight = parseFloat(ctx['originalHeight']);

                if (isNaN(originalHeight)) {
                    // Assume that original height was the same - scale it for 60% like in html
                    originalHeight = height / 0.6;
                }
                var scale = originalHeight / height;
                canvas.loadFromJSON(ctx);
                
                var offset = cWidthFull - cWidth - 45;

                canvas.forEachObject(function (object) {
                    object = object.scale(scale);
                    object.left = (object.left * scale) - offset;
                    object.top = object.top * scale;
                });

                canvas.renderAll();

                canvas.setBackgroundImage(
                    bgImg,
                    canvas.renderAll.bind(canvas), {
                        scaleX: imgScale,
                        scaleY: imgScale
                    },
                    {
                        left: 200,
                        originX: 'left',
                        originY: 'top'
                    }
                );

                canvas.setHeight(height);
                canvas.setWidth(cWidthFull);

                canvas.renderAll();
            });
        });
    }


    $(function () {
      // Init tooltips
      var is_touch_device = (
          ("ontouchstart" in window)
          || window.DocumentTouch
          && document instanceof DocumentTouch
      );

      if (is_touch_device) {
        $('[data-toggle="tooltip"]').tooltip({trigger: 'click'});
      } else {
        $('[data-toggle="tooltip"]').tooltip({trigger: 'hover'});
      }

      // Remove duplicate modals
      var seen = {};
      $('.observation-body[data-observation-id]').each(function () {
        var id = $(this).data('observation-id');
        if (seen[id])
          $(this).remove();
        else
          seen[id] = true;
      });

      // Launch modals
      $('[data-modal-launch-observations]').on('click', function (e) {
        var observationIds = $(this).data('modal-launch-observations');

        $('#the-modal .modal-body').html('');
        observationIds.forEach(function (id) {
          loadVideo(id, 'video');
          loadVideo(id, 'video-notes');

          $('#the-modal .modal-body').append($('[data-observation-id="' + id + '"]').clone());

          loadPicture(id);
        });

        var modal = $('#the-modal');
        modal.modal({
          size: 'lg',
          fade: true
        });
      });

      $('.nav-link').on('click', function (e) {
        var chart_href = $(this).attr('href');
        var chart_id = chart_href.substr(1);
        $('#filtering-submit').attr('name', chart_id);
        if (chart_id == "chart_v3") {
          $("#construct-row").removeClass('d-none');
          initSelect2();
          loadAllowedConstructs();
        } else {
          $("#construct-row").addClass('d-none');
        }
      });

      $('.nav-tabs a').on('shown.bs.tab', function (e) {
        // Mark current position to don't scroll after changing tab.
        const src = window.pageYOffset;
        window.location.hash = e.target.hash;
        window.scrollTo(0, src);
      })

      // Select chart after refresh or back.
      const url = window.location.href.split('/');
      $(`#chartTab a[href="${url[url.length - 1]}"]`).tab('show');
      window.scrollTo(0, 0);
    });
  </script>
{% endblock %}


{% block content %}
  <div class="container-fluid">
      {% csrf_token %}
      <div class="row">
        <div class="col-12">

          {% include "_base_filtering.html" %}

          <ul class="nav nav-tabs" id="chartTab" role="tablist">
            <li class="nav-item">
              <a class="nav-link {% if selected_chart == "chart_v1" %} active {% endif %}" data-toggle="tab" href="#chart_v1">Star Chart v1</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if selected_chart == "chart_v1_horizontal" %} active {% endif %}" data-toggle="tab" href="#chart_v1_horizontal">Star Chart v1 - Horizontal Collapse</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if selected_chart == "chart_v1_vertical" %} active {% endif %}" data-toggle="tab" href="#chart_v1_vertical">Star Chart v1 - Vertical Collapse</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if selected_chart == "chart_v2" %} active {% endif %}" data-toggle="tab" href="#chart_v2">Star Chart v2</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if selected_chart == "chart_v3" %} active {% endif %}" data-toggle="tab" href="#chart_v3">Star Chart v3</a>
            </li>
          </ul>

          <div class="tab-content">
            <div class="tab-pane {% if selected_chart == "chart_v1" %} active {% else %} fade {% endif %}" id="chart_v1">
              {% include "_star_chart_v1.html" %}
            </div>
            <div class="tab-pane {% if selected_chart == "chart_v1_horizontal" %} active {% else %} fade {% endif %}" id="chart_v1_horizontal">
              {% include "_star_chart_horizontal_v1.html" %}
            </div>
            <div class="tab-pane {% if selected_chart == "chart_v1_vertical" %} active {% else %} fade {% endif %}" id="chart_v1_vertical">
              {% include "_star_chart_vertical_v1.html" %}
            </div>
            <div class="tab-pane {% if selected_chart == "chart_v2" %} active {% else %} fade {% endif %}" id="chart_v2">
              {% include "_star_chart_v2.html" %}
            </div>
            <div class="tab-pane {% if selected_chart == "chart_v3" %} active {% else %} fade {% endif %}" id="chart_v3">
              {% include "_star_chart_v3.html" %}
            </div>
          </div>
        </div>
      </div>
  </div>


  {# MODALS #}
  <div class="d-none">
      {% for observation in all_observations %}
        <div class="observation-body" data-observation-id="{{ observation.id }}">
          <h3>
            <a href="{% url 'observation_detail_view' pk=observation.id %}">
                {% if observation.name %}
                    {{ observation.name }}
                {% else %}
                    Observation #{{ observation.id }}
                {% endif %}
            </a>
            <a href="{% url 'observation_detail_view' pk=observation.id %}" class="btn btn-primary pull-right">Edit</a>
          </h3>
          <small class="d-block"><b>Constructs:</b> {{ observation.constructs.all|join:', ' }}</small>
          <small class="d-block"><b>Observation date:</b> {{ observation.observation_date }}</small>
          <small class="d-block"><b>Recorded on:</b> {{ observation.created }}</small>
          <small class="d-block">
            <b>Other students included:</b>
            {% if observation.students.all|length > 1 %}
              {{ observation.students.all|join:', ' }}
            {% else %}
              -
            {% endif %}
          </small>
          <small class="d-block">
            <b>Students from group</b>: {{ observation.allowed_students|join:', ' }}
          </small>

          {% if observation.tags.count %}
            <b style="display: block;">Tags:</b>
            {% for tag in observation.tags.all %}
              <span class="chip">{{ tag.text }}</span>
            {% endfor %}
          {% endif %}

          {% if observation.original_image %}
          <div class="row no-gutters">
            <div class="col-12" style="">
              <div class="art" style="">
                <div style="display: flex; justify-content: center;">
                  <canvas id="{{ observation.id }}"></canvas>
                </div>
                <div class="d-none" id="annotation_data_{{ observation.id }}">{{ observation.annotation_data }}</div>
                <div class="d-none" id="image-source-{{ observation.id }}">{{ observation.original_image.url }}</div>
              </div>
            </div>
          </div>

          {% endif %}

          {% if observation.video %}
            <input id="video-source-{{ observation.id }}" value="{{ observation.video.url }}" class="hidden"/>
            <div id="video-{{ observation.id }}" style="display: flex; justify-content: center;"></div>
          {% endif %}

          {% if observation.notes %}
            <b style="display: block;">Note:</b>
            <p>{{ observation.notes }}</p>
          {% endif %}

          {% if observation.video_notes %}
            <b style="display: block;">Video Note:</b>
            <input id="video-notes-source-{{ observation.id }}" value="{{ observation.video_notes.url }}" class="hidden"/>
            <div id="video-notes-{{ observation.id }}" style="display: flex; justify-content: center;"></div>
          {% endif %}


          <div class="hr" style="height: 0;width: 100%;border-bottom: 2px solid #AAA; margin-bottom: 20px; margin-top: 20px"></div>
        </div>
      {% endfor %}
  </div>

  <!-- Modal -->
  <div class="modal fade" id="the-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-body">

        </div>
      </div>
    </div>
  </div>

{% endblock %}
