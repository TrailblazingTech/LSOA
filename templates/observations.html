{% extends 'base/b4_base_with_nav.html' %}

{% load staticfiles %}
{% load keyvalue %}

{% block extrastyles %}
  <link rel="stylesheet" href="{% static 'vendor/lightbox2/css/lightbox.min.css' %}">
  <style>
    [role="tooltip"] {
      z-index: 9999999;
    }

    table, .ios .page {
      background-color: #fff !important;
    }

    .modal.show {
      z-index: 5010;
    }

    [data-modal-launch-observations] {
      cursor: pointer;
    }

    [data-modal-launch-observations] i {
      color: goldenrod;
    }

    [data-modal-launch-observations]:hover i {
      color: darkgoldenrod;
    }

    .star-number {
      font-size: 12px;
    }

    .dot {
      height: 25px;
      width: 25px;
      background-color: #f2a287;
      border-radius: 50%;
      display: inline-block;
      margin: 3px auto;
    }

    .dot:hover {
      background-color: #cb6634;
    }

    /*
     * Height of date input is broken if there is no value. It have been
     * solved in higher version of bootstrap.
     */
    input[type="date"] {
	     height: 2.375rem;
    }
  </style>
{% endblock %}

{% block extrascripts %}
  <script src="{% static 'vendor/fabricjs/fabricjs.min.js' %}"></script>
  <script>
    $(function () {

      // Init tooltips
      var is_touch_device = (
          ("ontouchstart" in window)
          || window.DocumentTouch
          && document instanceof DocumentTouch
      );

      if (is_touch_device) {
        $('[data-toggle="tooltip"]').tooltip({trigger: 'click'});
      } else {
        $('[data-toggle="tooltip"]').tooltip({trigger: 'hover'});
      }

      // Remove duplicate modals
      var seen = {};
      $('.observation-body[data-observation-id]').each(function () {
        var id = $(this).data('observation-id');
        if (seen[id])
          $(this).remove();
        else
          seen[id] = true;
      });

      // Launch modals
      $('[data-modal-launch-observations]').on('click', function (e) {
        var observationIds = $(this).data('modal-launch-observations');

        $('#the-modal .modal-body').html('');
        observationIds.forEach(function (id) {
          $('#the-modal .modal-body').append($('[data-observation-id="' + id + '"]').clone());
          var $canvas = $('#the-modal .modal-body #' + id);
          $canvas.attr('id', 'canvas' + id);

          var annotation_data = $('#annotation_data_'+id).html();

          $('#the-modal').on('shown.bs.modal', function() {
            var canvas = new fabric.Canvas('canvas' + id, {
              isDrawingMode: false,
              selection: false
            });
            var $image = $('#the-modal .modal-body #image-' + id);
            var height = $image.height();
            var width = $image.width();

            canvas.setHeight(height);
            canvas.setWidth(width);

            var imageDom = document.getElementById("image-" + id)
            var naturalWidth = 1;
            var naturalHeight = 1;
            naturalWidth = imageDom.naturalWidth;
            naturalHeight = imageDom.naturalHeight;

            var xScale = width / naturalWidth;
            var yScale = height / naturalHeight;

            if (imageDom != null) {
              naturalWidth = imageDom.naturalWidth;
              naturalHeight = imageDom.naturalHeight;

            }

            $image.hide();

            var url = $('#url_'+id).html();
            if (url != undefined) {
              canvas.setBackgroundImage(
                decodeURI(url.replace(/&amp;/g, '&')),
                canvas.renderAll.bind(canvas), {
                  scaleX: xScale,
                  scaleY: yScale
                }
              );
            }

            if (annotation_data != undefined && annotation_data != "") {
              var ctx = JSON.parse(annotation_data.replace(/&quot;/g, '"'));
              var obj = ctx['objects'];
              for (var i in obj) {
                obj[i].height = obj[i].width * xScale;
                obj[i].width = obj[i].height * yScale;
                obj[i].left = obj[i].left * yScale;
                obj[i].top = obj[i].top * xScale;
              }
              canvas.loadFromJSON(ctx);
            }
          })

        });

        var modal = $('#the-modal');
        modal.modal({
          size: 'lg',
          fade: true
        });
      })

      $('#courseSelector').on('change', function(e) {
        var course_id = this.value;
        window.location = '{% url "observations_all" %}' + course_id
      });

    });
  </script>
{% endblock %}


{% block content %}
  <div class="container-fluid">
      {% csrf_token %}
      <div class="row">
        <div class="col-12">
          <div class="mt-3 mb-3 input-group">
            <div class="input-group-addon">
              <label class="mb-0" for="courseSelector">Filter class</label>
            </div>
            <select class="form-control" id="courseSelector">
              {% if not course_id %}
                <option selected>Choose...</option>
                {% else %}
                <option value="">All Students</option>
              {% endif %}
              {% for course in courses %}
                <option value="{{ course.id }}" {% if course.id == course_id|add:0 %}selected{% endif %}>{{ course.name }}</option>
              {% endfor %}
            </select>
          </div>

          <form action="" method="GET">
              <div class="row">
                <div class="col-6">
                    <label>Date from</label>
                    {{ date_form.date_from }}
                </div>
                <div class="col-6">
                    <label>Date to</label>
                    {{ date_form.date_to }}
                </div>
              </div>
              <div class="d-flex flex-row-reverse">
                <input type="submit" class="btn btn-primary">
              </div>
          </form>

          <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" data-toggle="tab" href="#chart_v1">Star Chart v1</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#chart_v2">Star Chart v2</a>
            </li>
          </ul>

          <div class="tab-content">
            <div class="tab-pane active" id="chart_v1">
                {% for table in star_chart_tables %}
                  <div style="overflow-x: scroll;width:100%;">
                    <h4 class="text-align-center" style="margin-bottom: 25px;">{{ table.c_name }}</h4>
                    <table class="table table-bordered">
                      <thead>
                      <tr>
                        <th scope="col">&nbsp;</th>
                        {% for csl_id, csl_data in table.construct_map.items %}
                          <th scope="col" title="{{ csl_data.description }}" data-toggle="tooltip">
                            {{ csl_data.name }}
                            {% if csl_data.description|length > 0 %}
                              <span><i class="fa fa-info-circle"></i></span>
                            {% endif %}
                          </th>
                        {% endfor %}
                      </tr>
                      </thead>
                      <tbody>

                      {% for student_id, construct_data in table.matrix.items %}
                        <tr>
                          <th scope="row">{{ table.student_map | keyvalue:student_id }}</th>
                          {% for csl_id, csl_data in table.construct_map.items %}
                            {% with exists=table.matrix|keyvalue:student_id|keyvalue:csl_id %}
                              <td data-csl-id="{{ csl_id }}" class="text-center"
                                  {% if exists %}data-modal-launch-observations="[{{ exists|join:',' }}]">
                                    <i data-toggle="tooltip" title=""
                                       class="fa fa-star"></i>{% if exists|length > 1 %}
                                    <span class="star-number">({{ exists|length }})</span>{% endif %}
                                  {% else %}>&nbsp;{% endif %}</td>
                            {% endwith %}
                          {% endfor %}
                        </tr>
                      {% endfor %}
                      </tbody>
                    </table>
                  </div>

                {% endfor %}
            </div>
            <div class="tab-pane fade" id="chart_v2">
              {% for table in dot_plot_tables %}
                <div style="overflow-x: scroll;width:100%;">
                  <h4 class="text-align-center"  style="margin-bottom: 25px;">{{ table.c_name }}</h4>
                  <table class="table table-bordered">
                    <thead>
                    <tr>
                      {% for csl_id, csl_data in table.construct_map.items %}
                        <th scope="col" title="{{ csl_data.description }}" data-toggle="tooltip">
                          {{ csl_data.name }}
                          {% if csl_data.description|length > 0 %}
                            <span><i class="fa fa-info-circle"></i></span>
                          {% endif %}
                        </th>
                      {% endfor %}
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                      {% for csl_id, csl_data in table.construct_map.items %}
                        <td>
                        {% for student_id, construct_data in table.matrix.items %}
                          {% for e in table.matrix|keyvalue:student_id|keyvalue:csl_id %}
                            <div class="row">
                              <span
                                class="dot"
                                data-csl-id="{{ csl_id }}"
                                data-modal-launch-observations="[{{ e }}]"
                              />
                            </div>
                          {% endfor %}
                        {% endfor %}
                        </td>
                      {% endfor %}
                    </tr>
                    </tbody>
                  </table>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
  </div>


  {# MODALS #}
  <div class="d-none">
    {% for table in star_chart_tables %}
      {% for observation in table.all_observations %}
        <div class="observation-body" data-observation-id="{{ observation.id }}">
          <h3><a href="{% url 'observation_detail_view' pk=observation.id %}">{% if observation.name %}{{ observation.name }}{% else %}Observation #{{ observation.id }}{% endif %}</a></h3>
          <small style="display: block;">Constructs: {{ observation.constructs.all|join:', ' }}</small>
          <small style="display: block;">Recorded on: {{ observation.created }}</small>
          {% if observation.tags.count %}
            <b style="display: block;">Tags:</b>
            {% for tag in observation.tags.all %}
              <span class="chip">{{ tag.text }}</span>
            {% endfor %}
          {% endif %}

          {% if observation.original_image %}
          <div class="row no-gutters">
            <div class="col-12" style="">
              <div class="art" style="">
                <canvas id="{{ observation.id }}" style="position: absolute;top: -400px;left: 0;bottom: 0;right: 0;"></canvas>
                <img class="" id="image-{{observation.id}}" src="{{ observation.original_image.url }}" alt="" style="width: 100%;"/>
                <div class="d-none" id="annotation_data_{{observation.id}}">{{observation.annotation_data}}</div>
                <div class="d-none" id="url_{{observation.id}}">{{observation.original_image.url}}</div>
              </div>
            </div>
          </div>

          {% endif %}

          {% if observation.video %}
            <video src="{{ observation.video.url }}" alt="" style="width: 100%; height: auto;"></video>
          {% endif %}

          {% if observation.notes %}
            <b style="display: block;">Note:</b>
            <p>{{ observation.notes }}</p>
          {% endif %}

          {% if observation.video_notes %}
            <b style="display: block;">Video Note:</b>
            <video src="{{ observation.video_notes.url }}" style="width: 100%; height: auto;"></video>
          {% endif %}

          {% if observation.students.all|length > 1 %}
            <small style="display: block;">Other students included: {{ observation.students.all|join:', ' }}</small>
          {% endif %}
          <div class="hr" style="height: 0;width: 100%;border-bottom: 2px solid #AAA; margin-bottom: 20px;"></div>
        </div>
      {% endfor %}
    {% endfor %}
  </div>

  <!-- Modal -->
  <div class="modal fade" id="the-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-body">

        </div>
      </div>
    </div>
  </div>

{% endblock %}
